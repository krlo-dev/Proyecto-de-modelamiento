<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Monitoreo de Consumo de Energía</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='estilos.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <div class="container">
    <h1>Monitoreo de Consumo de Energía</h1>

    <label for="fechaDato">Agregar dato - Fecha:</label>
    <input type="date" id="fechaDato" min="2025-01-01" max="2025-12-31" />

    <label for="consumoDato">Consumo (kWh):</label>
    <input type="number" id="consumoDato" step="any" min="0" />

    <button onclick="agregarDato()">Agregar</button>

    <table id="tablaDatos">
      <thead><tr><th>Día del Año</th><th>Consumo (kWh)</th></tr></thead>
      <tbody></tbody>
    </table>

    <hr />

    <label for="fechaEstimacion">Fecha a estimar:</label>
    <input type="date" id="fechaEstimacion" min="2025-01-01" max="2025-12-31" />
    <button onclick="estimar()">Estimar Consumo</button>
    <p id="resultado"></p>
    <canvas id="graficoConsumo"></canvas>
  </div>

  <script>
    const datos = [];
    let chart = null;

    const diaDelAnio = f => {
      const d = new Date(f + "T00:00:00"), ini = new Date(d.getFullYear(), 0, 1);
      return Math.floor((d - ini) / (1000 * 60 * 60 * 24)) + 1;
    };

    const actualizarTabla = () => {
      const tbody = document.querySelector("#tablaDatos tbody");
      tbody.innerHTML = datos.map(d => `<tr><td>${d.dia}</td><td>${d.consumo}</td></tr>`).join('');
      actualizarGrafico();
    };

    const agregarDato = () => {
      const fecha = document.getElementById("fechaDato").value;
      const consumo = parseFloat(document.getElementById("consumoDato").value);
      if (!fecha || isNaN(consumo)) return alert("Ingresa una fecha y consumo válidos.");
      const dia = diaDelAnio(fecha);
      datos.push({ dia, consumo });
      datos.sort((a, b) => a.dia - b.dia);
      actualizarTabla();
      alert(`Dato agregado para el día ${dia}`);
    };

    const actualizarGrafico = (estimado = null) => {
      const ctx = document.getElementById("graficoConsumo").getContext("2d");
      const puntos = datos.map(d => ({ x: d.dia, y: d.consumo }));

      const datasets = [
        {
          label: 'Datos',
          data: puntos,
          borderColor: '#ff8c00',
          backgroundColor: '#ff8c00',
          tension: 0,
          pointRadius: 5,
          fill: false,
          order: 1
        }
      ];

      if (estimado) {
        datasets.push({
          label: 'Estimado',
          data: [estimado],
          backgroundColor: '#163157',
          borderColor: '#163157',
          pointRadius: 8,
          pointStyle: 'circle',
          showLine: false,
          order: 0
        });
      }

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          scales: {
            x: { type: 'linear', title: { display: true, text: 'Día del Año' } },
            y: { title: { display: true, text: 'Consumo (kWh)' } }
          },
          plugins: {
            legend: { labels: { usePointStyle: true } }
          }
        }
      });
    };

    const estimar = async () => {
      const fecha = document.getElementById("fechaEstimacion").value;
      if (!fecha) return alert("Selecciona una fecha para estimar.");
      if (datos.length < 2) return alert("Se necesitan al menos dos datos para estimar.");

      const x = diaDelAnio(fecha);
      const X = datos.map(d => d.dia), Y = datos.map(d => d.consumo);

      try {
        const res = await fetch("http://localhost:5000/interpolate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ x, X, Y })
        });

        const data = await res.json();

        if (!res.ok || data.resultado === undefined) {
          document.getElementById("resultado").textContent = "No se pudo estimar el consumo.";
          actualizarGrafico();
          return;
        }

        document.getElementById("resultado").textContent =
          `Consumo estimado para el día ${x}: ${data.resultado.toFixed(2)} kWh`;
        actualizarGrafico({ x, y: data.resultado });

      } catch (err) {
        document.getElementById("resultado").textContent = "Seleccione un rango válido.";
      }
    };
  </script>
</body>
</html>
